Из-за разных моментов как можно сделать и переделать. Я пока пришел к тому последнему варианту на котором решил остановиться. 

## Быстрый старт ##
```
./start.sh 
#скрипт создает файл cloud-config.yaml чтобы не хранился в репозитории и первый прогон терраформа создает в нем информацию для установки при создании виртуалок. Но так как терраформ не может в эту же сессию считать инфу из файла, запускаю терраформ повторно. 

Для проверки в конце работы терраформ венет IP адрес лоад балансера в файле /etc/hosts необходимо прописать IP балансировщика и доменное имя test1.com
Пример:
51.250.34.100 test1.com
В браузере открыть test1.com


В корне проекта будет лежать ключик ssh если необходимо подключиться к хостам. 
ssh -i id_rsa ubuntu@{IP нужного хоста, можно смотреть в файле hosts в корне проекта}

```
## для остановки ##
```
./stop.sh
```
и потом надо будет подтвердить. 



## Подробности. ##
Внутренняя сеть 
10.5.0.11 - backend1 (node1) (папка с gfs2 /usr/share/nginx/html)
10.5.0.12 - backend2 (node2) (папка с gfs2 /usr/share/nginx/html)

10.5.0.101 - nginx1
10.5.0.102 - nginx2

10.5.0.200 - db (он же шара с gfs2, там второй диск) 




Погнали по командам, чтобы запуститься надо чтобы был настроен yc.

Дальше создали сервисный аккаунт 
```
yc iam service-account create --name otus_service_account
```
проверили его и достали его айди 
```
yc iam service-account list
```
Подставляем айди генерим key.json
```
yc iam key create  --service-account-id <ID>   --output key.json
```

Дальше конфигурируем
```
yc config set service-account-key key.json
yc config set cloud-id <ID клауда>
yc config set folder-id <ID фолдер>
```

Потом экспортируем переменные для работы терраформа 
```
export YC_TOKEN=$(yc iam create-token)
export YC_CLOUD_ID=$(yc config get cloud-id) 
export YC_FOLDER_ID=$(yc config get folder-id)
```

Дальше чтобы меньше файлов ложить в гит и чтобы все работало с 1 запускаемого файла и чтобы баг который чуть ниже описан, и дальше чтобы виртуалка успела запуститься стоит время в 60 секунд паузы между виртуалкой и ансиблом плейбуком, сделал bash скрипт start.sh 

Согласно бага яндекса и терраформа 

`https://yandex.cloud/ru/docs/troubleshooting/compute/known-issues/permission-denied-error-when-connected-as-user-created-from-terraform-manifest`

Можно конечно еще пострадать и перехерачить чегото, но в целом трохи гдето прокачался, гдето понял что кнопку сделать "Сделать все пи....!" сделать можно, но костылями. 
В дополнение чтобы понимать что Nginx мой и заработал закидываю в него файл index.html чтобы в браузере открывался и показывал. 

Когда все отработает терраформ выдаст instance_ip_address перейда по данному айпи можно наблюдать страницу index.html

###Как то так!


При запуске докер контейнеров может выпадать ошибка необходимо обновить 
ansible-galaxy collection install community.docker --force
